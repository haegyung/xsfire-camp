name: Release

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag name for release (optional - uses version from Cargo.toml if not specified)"
        required: false
        type: string
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  NPM_PUBLISH_OIDC_SCOPE: ${{ vars.NPM_PUBLISH_OIDC_SCOPE || '@haegyung' }}
  NPM_PUBLISH_OIDC_REPO: ${{ vars.NPM_PUBLISH_OIDC_REPO || 'theprometheusxyz/xsfire-camp' }}
  NPM_PUBLISH_OIDC_SCOPE_EXPECTED: "@haegyung"
  NPM_PUBLISH_OIDC_REPO_EXPECTED: "theprometheusxyz/xsfire-camp"

jobs:
  get-version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}
    steps:
      - name: Checkout xsfire-camp
        uses: actions/checkout@v4

      - name: Get version from Cargo.toml
        id: get_version
        run: |
          VERSION=$(grep -m1 "^version" Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          if [ -n "${{ github.event.inputs.tag_name }}" ]; then
            echo "tag_name=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "push" ]; then
            echo "tag_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag_name=v$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Verify tag matches Cargo.toml version
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          TAG_NAME="${{ steps.get_version.outputs.tag_name }}"
          EXPECTED="v$VERSION"
          if [ "$TAG_NAME" != "$EXPECTED" ]; then
            echo "Tag/version mismatch: tag_name=$TAG_NAME expected=$EXPECTED (Cargo.toml version=$VERSION)" >&2
            exit 1
          fi

  build:
    name: Build - ${{ matrix.os }}
    needs: get-version
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            target: aarch64-apple-darwin
            binary_extension: ""
          - os: macos-14
            target: x86_64-apple-darwin
            binary_extension: ""
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            binary_extension: ""
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-musl
            binary_extension: ""
          - os: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu
            binary_extension: ""
          - os: ubuntu-22.04-arm
            target: aarch64-unknown-linux-musl
            binary_extension: ""
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary_extension: ".exe"
          - os: windows-11-arm
            target: aarch64-pc-windows-msvc
            binary_extension: ".exe"

    runs-on: ${{ matrix.os }}

    # Secrets are unavailable in forks and in some contexts are not exposed in expressions.
    # We flow them into job env, then gate signing steps based on whether the values are set.
    env:
      MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
      MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
      APPLE_NOTARIZATION_KEY: ${{ secrets.APPLE_NOTARIZATION_KEY }}
      APPLE_NOTARIZATION_KEY_ID: ${{ secrets.APPLE_NOTARIZATION_KEY_ID }}
      APPLE_NOTARIZATION_ISSUER_ID: ${{ secrets.APPLE_NOTARIZATION_ISSUER_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_SIGNING_TENANT_ID }}
      AZURE_CLIENT_ID: ${{ secrets.AZURE_SIGNING_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_SIGNING_CLIENT_SECRET }}
      ACCOUNT_NAME: ${{ vars.AZURE_SIGNING_ACCOUNT_NAME }}
      CERT_PROFILE_NAME: ${{ vars.AZURE_SIGNING_CERT_PROFILE_NAME }}
      ENDPOINT: ${{ vars.AZURE_SIGNING_ENDPOINT }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ matrix.os }}-${{ matrix.target }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ matrix.os }}-${{ matrix.target }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ matrix.os }}-${{ matrix.target }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ matrix.os }}-${{ matrix.target }}-cargo-git-

      - if: ${{ matrix.target == 'x86_64-unknown-linux-musl' || matrix.target == 'aarch64-unknown-linux-musl'}}
        name: Install musl build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools pkg-config

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Code sign macOS binary
        if: startsWith(matrix.os, 'macos') && env.MACOS_CERTIFICATE != ''
        run: |
          ./scripts/sign-mac target/${{ matrix.target }}/release/xsfire-camp

      - name: Code sign Windows binary
        if: startsWith(matrix.os, 'windows') && env.AZURE_TENANT_ID != ''
        env:
          FILE_DIGEST: SHA256
          TIMESTAMP_DIGEST: SHA256
          TIMESTAMP_SERVER: http://timestamp.acs.microsoft.com
        run: |
          .\scripts\sign-windows.ps1 target\${{ matrix.target }}\release\xsfire-camp.exe

      - name: Create archive
        id: create_archive
        shell: bash
        run: |
          BINARY_NAME="xsfire-camp${{ matrix.binary_extension }}"
          ARCHIVE_NAME="xsfire-camp-${{ needs.get-version.outputs.version }}-${{ matrix.target }}"

          cd target/${{ matrix.target }}/release

          if [ "${{ matrix.os }}" = "windows-latest" ] || [ "${{ matrix.os }}" = "windows-11-arm" ]; then
            7z a -tzip "${ARCHIVE_NAME}.zip" "${BINARY_NAME}"
            echo "archive_path=${ARCHIVE_NAME}.zip" >> $GITHUB_OUTPUT
            echo "archive_name=${ARCHIVE_NAME}.zip" >> $GITHUB_OUTPUT
            mv "${ARCHIVE_NAME}.zip" ../../../
          else
            tar czf "${ARCHIVE_NAME}.tar.gz" "${BINARY_NAME}"
            echo "archive_path=${ARCHIVE_NAME}.tar.gz" >> $GITHUB_OUTPUT
            echo "archive_name=${ARCHIVE_NAME}.tar.gz" >> $GITHUB_OUTPUT
            mv "${ARCHIVE_NAME}.tar.gz" ../../../
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.create_archive.outputs.archive_name }}
          path: ${{ steps.create_archive.outputs.archive_path }}
          retention-days: 1

  npm-packages:
    name: Create NPM Packages
    needs: [get-version, build]
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.create_packages.outputs.packages }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "lts/*"
          registry-url: "https://registry.npmjs.org"

      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: artifacts
          merge-multiple: true

      - name: Display structure of downloaded files
        run: ls -la artifacts/

      - name: Create platform-specific packages
        run: bash npm/publish/create-platform-packages.sh ./artifacts ./npm-packages ${{ needs.get-version.outputs.version }}

      - name: Update base package version
        run: bash npm/publish/update-base-package.sh ${{ needs.get-version.outputs.version }}

      - name: Upload NPM packages
        uses: actions/upload-artifact@v4
        with:
          name: npm-packages
          path: npm-packages/
          retention-days: 1

      - name: Upload base package
        uses: actions/upload-artifact@v4
        with:
          name: npm-base-package
          path: npm/
          retention-days: 1

  publish-npm-platform:
    name: Publish NPM Platform Packages
    needs: [get-version, npm-packages]
    runs-on: ubuntu-latest
    if: ${{ (github.event_name == 'workflow_dispatch' || github.event_name == 'push') && !github.event.repository.fork }}
    environment: release # Optional: for enhanced security
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Check whether NPM publishing is configured
        id: publish_config
        shell: bash
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_OIDC_PUBLISH: ${{ vars.NPM_OIDC_PUBLISH }}
        run: |
          NPM_OIDC_PUBLISH_ENABLED=0
          case "${NPM_OIDC_PUBLISH,,}" in
            1|true|yes|on)
              NPM_OIDC_PUBLISH_ENABLED=1
              ;;
          esac

          if [ -n "${NPM_TOKEN:-}" ] || [ "$NPM_OIDC_PUBLISH_ENABLED" = "1" ]; then
            echo "enabled=1" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=0" >> "$GITHUB_OUTPUT"
            echo "NPM publishing not configured (NPM_TOKEN empty and NPM_OIDC_PUBLISH is not enabled). Skipping."
          fi

      - name: Verify OIDC target metadata
        if: steps.publish_config.outputs.enabled == '1'
        run: |
          if [ "${NPM_PUBLISH_OIDC_SCOPE}" != "${NPM_PUBLISH_OIDC_SCOPE_EXPECTED}" ]; then
            echo "::error::OIDC scope mismatch: configured scope is ${NPM_PUBLISH_OIDC_SCOPE}, but expected ${NPM_PUBLISH_OIDC_SCOPE_EXPECTED}."
            exit 1
          fi
          if [ "${NPM_PUBLISH_OIDC_REPO}" != "${NPM_PUBLISH_OIDC_REPO_EXPECTED}" ]; then
            echo "::error::OIDC repository mismatch: configured repository is ${NPM_PUBLISH_OIDC_REPO}, but expected ${NPM_PUBLISH_OIDC_REPO_EXPECTED}."
            exit 1
          fi
          echo "Configured OIDC scope: ${NPM_PUBLISH_OIDC_SCOPE}"
          echo "Configured OIDC repository: ${NPM_PUBLISH_OIDC_REPO}"
          echo "Current repository: ${GITHUB_REPOSITORY}"
          if [ "${GITHUB_REPOSITORY}" != "${NPM_PUBLISH_OIDC_REPO}" ]; then
            echo "::error::OIDC publish path mismatch: workflow is running on ${GITHUB_REPOSITORY}, but trusted publishing is configured for ${NPM_PUBLISH_OIDC_REPO}."
            exit 1
          fi

      - name: Setup Node.js
        if: steps.publish_config.outputs.enabled == '1'
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
          scope: ${{ env.NPM_PUBLISH_OIDC_SCOPE }}
      - name: Update npm
        if: steps.publish_config.outputs.enabled == '1'
        run: npm install -g npm@10

      - name: Download NPM packages
        if: steps.publish_config.outputs.enabled == '1'
        uses: actions/download-artifact@v5
        with:
          name: npm-packages
          path: npm-packages

      - name: Publish platform packages
        if: steps.publish_config.outputs.enabled == '1'
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_OIDC_PUBLISH: ${{ vars.NPM_OIDC_PUBLISH }}
        run: |
          NPM_CONFIG_USERCONFIG="${NPM_CONFIG_USERCONFIG:-$HOME/.npmrc}"

          # If NPM_TOKEN is not set, we fall back to npm "trusted publishing" (OIDC) via --provenance.
          # If neither is configured, npm will fail with ENEEDAUTH.
          NPM_OIDC_PUBLISH_ENABLED=0
          case "${NPM_OIDC_PUBLISH,,}" in
            1|true|yes|on)
              NPM_OIDC_PUBLISH_ENABLED=1
              ;;
          esac

          if [ -n "${NPM_TOKEN:-}" ]; then
            {
              echo "registry=https://registry.npmjs.org/"
              echo "${NPM_PUBLISH_OIDC_SCOPE}:registry=https://registry.npmjs.org/"
              echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}"
            } > "${NPM_CONFIG_USERCONFIG}"
            echo "Using NPM_TOKEN for authentication."
            PUBLISH_ARGS="--access public --provenance"
            USING_OIDC=0
          elif [ "$NPM_OIDC_PUBLISH_ENABLED" = "1" ]; then
            if [ -z "${NODE_AUTH_TOKEN:-}" ]; then
              echo "NPM_TOKEN is empty and OIDC publish is enabled, but NODE_AUTH_TOKEN is not available."
              echo "Run with setup-node id-token integration and repository trusted publisher settings for scope ${NPM_PUBLISH_OIDC_SCOPE}."
              exit 1
            fi
            {
              echo "registry=https://registry.npmjs.org/"
              echo "${NPM_PUBLISH_OIDC_SCOPE}:registry=https://registry.npmjs.org/"
            } > "${NPM_CONFIG_USERCONFIG}"
            echo "OIDC publish is enabled; using NODE_AUTH_TOKEN from workflow environment."
            echo "Using GitHub OIDC trusted publishing (npm provenance) for scope ${NPM_PUBLISH_OIDC_SCOPE} + ${NPM_PUBLISH_OIDC_REPO}."
            PUBLISH_ARGS="--access public --provenance"
            USING_OIDC=1
          else
            echo "No npm publish authentication method is enabled."
            exit 1
          fi

          if [ -n "${NPM_TOKEN:-}" ]; then
            if npm whoami >/tmp/npm-whoami-platform.log 2>&1; then
              echo "Authenticated to npm as $(cat /tmp/npm-whoami-platform.log)."
            else
              echo "NPM_TOKEN authentication check failed before publish."
              cat /tmp/npm-whoami-platform.log
              exit 1
            fi
          fi

          for pkg in npm-packages/*; do
            if [ -d "$pkg" ]; then
              echo "Publishing $(basename $pkg)..."
              cd "$pkg"
              if ! npm publish $PUBLISH_ARGS 2> /tmp/npm-publish-platform.log; then
                PUBLISH_RESULT=$?
                if [ "$USING_OIDC" -eq 1 ]; then
                  echo "Trusted publishing failed for $(basename "$pkg")."
                  echo "1) Verify scope '${NPM_PUBLISH_OIDC_SCOPE}' is configured as a trusted publisher for repository '${NPM_PUBLISH_OIDC_REPO}' in npm."
                  echo "2) Confirm this workflow has 'id-token: write' permission and uses npm >= 9.5."
                  echo "3) Retry after enabling a valid repository secret NPM_TOKEN."
                  cat /tmp/npm-publish-platform.log
                  exit 1
                fi
                cat /tmp/npm-publish-platform.log 2>/dev/null || true
                exit "$PUBLISH_RESULT"
              fi
              cd ../..
            fi
          done

  publish-npm-base:
    name: Publish NPM Base Package
    needs: [get-version, npm-packages, publish-npm-platform]
    runs-on: ubuntu-latest
    if: ${{ (github.event_name == 'workflow_dispatch' || github.event_name == 'push') && !github.event.repository.fork }}
    environment: release # Optional: for enhanced security
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Check whether NPM publishing is configured
        id: publish_config
        shell: bash
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_OIDC_PUBLISH: ${{ vars.NPM_OIDC_PUBLISH }}
        run: |
          NPM_OIDC_PUBLISH_ENABLED=0
          case "${NPM_OIDC_PUBLISH,,}" in
            1|true|yes|on)
              NPM_OIDC_PUBLISH_ENABLED=1
              ;;
          esac

          if [ -n "${NPM_TOKEN:-}" ] || [ "$NPM_OIDC_PUBLISH_ENABLED" = "1" ]; then
            echo "enabled=1" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=0" >> "$GITHUB_OUTPUT"
            echo "NPM publishing not configured (NPM_TOKEN empty and NPM_OIDC_PUBLISH is not enabled). Skipping."
          fi

      - name: Verify OIDC target metadata
        if: steps.publish_config.outputs.enabled == '1'
        run: |
          if [ "${NPM_PUBLISH_OIDC_SCOPE}" != "${NPM_PUBLISH_OIDC_SCOPE_EXPECTED}" ]; then
            echo "::error::OIDC scope mismatch: configured scope is ${NPM_PUBLISH_OIDC_SCOPE}, but expected ${NPM_PUBLISH_OIDC_SCOPE_EXPECTED}."
            exit 1
          fi
          if [ "${NPM_PUBLISH_OIDC_REPO}" != "${NPM_PUBLISH_OIDC_REPO_EXPECTED}" ]; then
            echo "::error::OIDC repository mismatch: configured repository is ${NPM_PUBLISH_OIDC_REPO}, but expected ${NPM_PUBLISH_OIDC_REPO_EXPECTED}."
            exit 1
          fi
          echo "Configured OIDC scope: ${NPM_PUBLISH_OIDC_SCOPE}"
          echo "Configured OIDC repository: ${NPM_PUBLISH_OIDC_REPO}"
          echo "Current repository: ${GITHUB_REPOSITORY}"
          if [ "${GITHUB_REPOSITORY}" != "${NPM_PUBLISH_OIDC_REPO}" ]; then
            echo "::error::OIDC publish path mismatch: workflow is running on ${GITHUB_REPOSITORY}, but trusted publishing is configured for ${NPM_PUBLISH_OIDC_REPO}."
            exit 1
          fi

      - name: Setup Node.js
        if: steps.publish_config.outputs.enabled == '1'
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
          scope: ${{ env.NPM_PUBLISH_OIDC_SCOPE }}
      - name: Update npm
        if: steps.publish_config.outputs.enabled == '1'
        run: npm install -g npm@10

      - name: Download base package
        if: steps.publish_config.outputs.enabled == '1'
        uses: actions/download-artifact@v5
        with:
          name: npm-base-package
          path: npm

      - name: Wait for platform packages to be available
        if: steps.publish_config.outputs.enabled == '1'
        run: |
          echo "Waiting 30 seconds for platform packages to be available on npm..."
          sleep 30

      - name: Publish base package
        if: steps.publish_config.outputs.enabled == '1'
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_OIDC_PUBLISH: ${{ vars.NPM_OIDC_PUBLISH }}
        run: |
          NPM_CONFIG_USERCONFIG="${NPM_CONFIG_USERCONFIG:-$HOME/.npmrc}"

          NPM_OIDC_PUBLISH_ENABLED=0
          case "${NPM_OIDC_PUBLISH,,}" in
            1|true|yes|on)
              NPM_OIDC_PUBLISH_ENABLED=1
              ;;
          esac

          if [ -n "${NPM_TOKEN:-}" ]; then
            {
              echo "registry=https://registry.npmjs.org/"
              echo "${NPM_PUBLISH_OIDC_SCOPE}:registry=https://registry.npmjs.org/"
              echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}"
            } > "${NPM_CONFIG_USERCONFIG}"
            echo "Using NPM_TOKEN for authentication."
            PUBLISH_ARGS="--access public --provenance"
            USING_OIDC=0
            if npm whoami >/tmp/npm-whoami-base.log 2>&1; then
              echo "Authenticated to npm as $(cat /tmp/npm-whoami-base.log)."
            else
              echo "NPM_TOKEN authentication check failed before publish."
              cat /tmp/npm-whoami-base.log
              exit 1
            fi
          elif [ "$NPM_OIDC_PUBLISH_ENABLED" = "1" ]; then
            if [ -z "${NODE_AUTH_TOKEN:-}" ]; then
              echo "NPM_TOKEN is empty and OIDC publish is enabled, but NODE_AUTH_TOKEN is not available."
              echo "Run with setup-node id-token integration and repository trusted publisher settings for scope ${NPM_PUBLISH_OIDC_SCOPE}."
              exit 1
            fi
            {
              echo "registry=https://registry.npmjs.org/"
              echo "${NPM_PUBLISH_OIDC_SCOPE}:registry=https://registry.npmjs.org/"
            } > "${NPM_CONFIG_USERCONFIG}"
            echo "OIDC publish is enabled; using NODE_AUTH_TOKEN from workflow environment."
            echo "Using GitHub OIDC trusted publishing (npm provenance) for scope ${NPM_PUBLISH_OIDC_SCOPE} + ${NPM_PUBLISH_OIDC_REPO}."
            PUBLISH_ARGS="--access public --provenance"
            USING_OIDC=1
          else
            echo "No npm publish authentication method is enabled."
            exit 1
          fi

          cd npm
          if ! npm publish $PUBLISH_ARGS 2> /tmp/npm-publish-base.log; then
            PUBLISH_RESULT=$?
            if [ "$USING_OIDC" -eq 1 ]; then
              echo "Trusted publishing failed for base package."
              echo "1) Verify scope '${NPM_PUBLISH_OIDC_SCOPE}' is configured as a trusted publisher for repository '${NPM_PUBLISH_OIDC_REPO}' in npm."
              echo "2) Confirm this workflow has 'id-token: write' permission and uses npm >= 9.5."
              echo "3) Retry after enabling a valid repository secret NPM_TOKEN."
              cat /tmp/npm-publish-base.log
              exit 1
            fi
            cat /tmp/npm-publish-base.log 2>/dev/null || true
            exit "$PUBLISH_RESULT"
          fi

  create-release:
    name: Create Release
    needs: [get-version, build]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -la artifacts/

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.get-version.outputs.tag_name }}
          name: Release ${{ needs.get-version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
